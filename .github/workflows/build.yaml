name: Build

on:
  push:
    branches:
    - adding_build_ci
#    - development
#    - '[0-9]+.[0-9]+.x'

jobs:
  build-images:
    name: Build and push ui image
    runs-on: ubuntu-latest

    # let's not run this on every fork, change to your fork when developing
    if: github.repository == 'hedingber/ui'
    env:
      # When developing set this to your github username
      MLRUN_DOCKER_REPO: 'hedingber'

    steps:
    - uses: actions/checkout@v2
    - name: Install curl and jq
      run: sudo apt-get install curl jq
    - name: Set LATEST_VERSION env var
      run: echo "::set-env name=LATEST_VERSION::$(curl -sf https://pypi.org/pypi/mlrun/json | jq -r '.info.version')"
    - name: Set GIT_HASH env var
      run: echo "::set-env name=GIT_HASH::$(git rev-parse --short $GITHUB_SHA)"
    - name: Set MLRUN_DOCKER_TAG env var
      run: echo "::set-env name=MLRUN_DOCKER_TAG::$(echo $LATEST_VERSION-$GIT_HASH)"
    - name: Setup Node.js 12
      uses: actions/setup-node@v1
      with:
        node-version: '12'
    - name: Docker login
      run: echo ${{ secrets.CR_PAT }} | docker login ghcr.io -u ${{ secrets.CR_USERNAME }} --password-stdin
    - name: Build image

      run: MLRUN_DOCKER_REGISTRY=ghcr.io/ MLRUN_DOCKER_REPO="$MLRUN_DOCKER_REPO" MLRUN_DOCKER_TAG="$MLRUN_DOCKER_TAG" npm run docker
    - name: Push image
      run: docker push ghcr.io/"$MLRUN_DOCKER_REPO"/ui:"$MLRUN_DOCKER_TAG"
